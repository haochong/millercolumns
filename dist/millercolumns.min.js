/*! millercolumns 21-02-2013 */
(function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()})("column.data.item",function(){var e=$.cache("column").get("items")||{},t=$.cache("column").get("itemsIndex")||{},o=function(){$.cache("column").set("items",e),$.cache("column").set("itemsIndex",t)};$.radio("column.data.item.list").subscribe(function(o){var a=o&&o.id,i=o&&o.callback,n="column.data.item.list error",d="";i&&"[object Function]"==={}.toString.call(i)?($.radio("log").broadcast({key:"column.data.item.list ",value:t[a]}),i({id:a,items:e,itemsIndex:t[a]})):d=" callback function",d&&$.radio("log").broadcast({key:n,value:d})}),$.radio("column.data.item.add").subscribe(function(a){var i=a&&a.parent,n=a&&a.key,d=a&&a.value;e[n]||(t[i]||(t[i]=[]),t[i].push(n)),e[n]={content:d},$.radio("log").broadcast({key:"column.data.item.add",value:a}),o()}),$.radio("column.data.item.move").subscribe(function(e){var a="column.data.item.move",i=e&&e.id,n=e&&e.fromWrap,d=e&&e.toWrap,r=e&&e.toEl;$.radio("log").broadcast({key:a,value:i}),t[n].splice(t[n].indexOf(i),1),t[d]||(t[d]=[]),t[d].splice(t[d].indexOf(r),0,i),o()}),$.radio("column.data.item.remove").subscribe(function(a){var i=a&&a.parent,n=a&&a.key;delete e[n],t[i].splice(t[i].indexOf(n),1),o()})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.events",function(){var e;$(window).on("resize",function(){clearTimeout(e),e=setTimeout(function(){$.radio("column.resize").broadcast()},300)}),$(".events-wrap").on("click",function(e){var t=$(e.target),o=t.data("event-key"),a=t.data("event-wrap")||".events-wrap";o?$.radio(o).broadcast({wrap:t.closest(a),timestamp:+new Date}):$.radio("log").broadcast({key:"column.events warn",value:" no event key"})}),$.radio("column.events.drag.bind").subscribe(function(e){var t=e&&e.wrap;$(t).dagron({handle:".handle",target:".droptarget",start:function(e){$(e).hasClass("item-open")&&$.radio("column.item.close").broadcast({wrap:$(e)})},drag:function(e){$(".dragging").removeClass("dragging"),$(e).addClass("dragging"),console.log("dragging",e)},drop:function(e){$.radio("column.item.move").broadcast({el:$(".dragging"),target:e}),console.log("drop ",e)},enter:function(e){$(".drag-enter").removeClass("drag-enter"),$(e).addClass("drag-enter"),console.log("enter ",e)},leave:function(e){console.log("leave ",e)},end:function(e){console.log("end dragg ",e),$(".drag-enter").removeClass("drag-enter")}}),$.radio("log").broadcast({key:"column.events.bind.drag",value:t})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.header.set",function(){var e="column.header.set",t=e+" error",o="";$.radio(e).subscribe(function(a){var i=a&&a.value;i?$(".column-view-header h2").html(i):o="empty header value",o&&$.radio("log").broadcast({key:t,value:o}),$.radio("log").broadcast({key:e,value:i})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.add",function(){$.radio("column.item.add").subscribe(function(e){var t,o=e&&e.wrap,a=(o&&o.data("id"),o.find(".list")),i=e&&e.id,n=e&&e.content,d=' <a href="javascript:;" class="btn-item-remove" data-event-key="column.item.remove" data-event-wrap=".item">x</a>',r=' <a href="javascript:;" class="btn-item-edit" data-event-key="column.item.edit" data-event-wrap=".item">edit</a>',l='<div class="action-wrap">'+r+d+"</div>",s="column.item.add error",c='<div data-event-key="column.item.open" data-event-wrap=".item" class="content handle">'+n+"</div>",u=n?"item draggables droptarget":"item item-edit droptarget",m=n?i:require("uuid-v4")(),f='<li data-id="'+m+'" class="'+u+'">'+c+l+"</li>";o||(t="column wrap not found error"),o?(a.append(f),n||$.radio("column.item.edit").broadcast({wrap:a})):$.radio("log").broadcast({key:s,value:t})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.close",function(){var e="column.item.close";$.radio(e).subscribe(function(e){for(var t=e&&e.wrap,o=t.closest(".list-wrap"),a=o.next();a.length;)a.remove(),a=o.next();t.removeClass("item-open").removeClass("item-open-old"),$(".item-open").addClass("item-open-old")})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.toolbar",function(){$.radio("column.item.create").subscribe(function(e){var t=e&&e.wrap;console.log("create ",t),t?$.radio("column.item.add").broadcast({wrap:t,content:""}):$.radio("log").broadcast({key:"column.item.create error ",value:" no wrap found"})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.edit",function(){var e="column.item.edit";$.radio(e).subscribe(function(t){var o,a,i=t&&t.wrap,n=i.find(".item-edit"),d=function(e){var t=$(e);t.hasClass("item-edit")||(t=t.closest(".item-edit")),$.radio("column.item.save").broadcast({wrap:$(e).closest(".list-wrap"),el:t})},r=function(e){13===e.keyCode&&d(e.target)};i?(n.length||(n=i,n.addClass("item-edit")),n?(o=n.find(".content"),a='<div class="item-edit-input-wrap"><input class="item-edit-input" value="'+o.html()+'" /></div>',n.append(a),n.find(".item-edit-input").on("keypress",r).focus(),o.hide(),n.find(".action-wrap").hide()):$.radio("log").broadcast({key:e+" error",value:".item-edit element not exist"})):$.radio("log").broadcast({key:e+" error",value:"wrap not exist"})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.list",function(){var e="column.item.list";$.radio(e).subscribe(function(t){var o,a,i=t&&t.id,n=t&&t.items,d=t&&t.itemsIndex,r=n&&d&&d.length,l=0;if(a='<div class="list-wrap" data-id="'+i+'">',a+='<ul class="list"></ul>',a+="</div></div>",$(".column-view-wrap").append(a),newWidth=310*$(".list-wrap").length,$(".column-view-wrap").css({width:newWidth}),$.radio("column.resize").broadcast(),window.scrollTo(newWidth,0),o=$(".list-wrap").last(),r)for(;r>l;l++)$.radio("log").broadcast({key:e,value:" adding "+d[l]}),$.radio("column.item.add").broadcast({parent:0,id:d[l],wrap:o,content:n[d[l]].content});else $.radio("log").broadcast({key:"column.init",value:" empty column"});$.radio("column.item.add").broadcast({wrap:o,content:""}),$.radio("column.events.drag.bind").broadcast({wrap:o.find(".draggables")}),$.radio("log").broadcast({key:e,value:t})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.move",function(){var e,t="column.item.move",o=t+" error";$.radio(t).subscribe(function(a){var i,n=a&&a.el,d=$(n).closest(".list-wrap"),r=a&&$(a.target);d.length||(e="from wrap not found"),r.length||(e="to el not found"),$(r).hasClass("list-wrap")||(i=$(r).closest(".list-wrap")),$.radio("log").broadcast({key:t+" from",value:d}),$.radio("log").broadcast({key:t+" to",value:i}),$.radio("column.data.item.move").broadcast({id:n.data("id"),fromWrap:d.data("id"),toEl:r.data("id"),toWrap:i.data("id")}),$(n).insertBefore($(r)),e&&$.radio("log").broadcast({key:o,value:e})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.open",function(){var e="column.item.open";$.radio(e).subscribe(function(t){var o=t&&t.wrap,a=o.closest(".list-wrap"),i=o.data("id"),n=$(".item-edit.draggables");return o.hasClass("item-open")&&!o.hasClass("item-open-old")?($.radio("column.item.edit").broadcast({wrap:o}),$.radio("log").broadcast({key:e,value:"click current opened item will edit it"}),void 0):(n.length&&$.radio("column.item.save").broadcast({wrap:n.closest(".list-wrap"),el:n}),$.radio("column.item.close").broadcast({wrap:a.find(".item-open")}),$.radio("column.header.set").broadcast({value:o.find(".content").html()}),o.addClass("item-open"),$.radio("column.data.item.list").broadcast({id:i,callback:function(e){$.radio("column.item.list").broadcast(e)}}),$.radio("log").broadcast({key:e,value:i}),void 0)})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.remove",function(){$.radio("column.item.remove").subscribe(function(e){var t=e&&e.wrap,o=t.closest(".list-wrap").data("id"),a=t.data("id");t&&a&&(t.remove(),$.radio("column.data.item.remove").broadcast({key:a,parent:o}))})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.item.save",function(){$.radio("column.item.save").subscribe(function(e){var t,o=e&&e.wrap,a=e&&e.el,i=o.data("id"),n=a.length&&a.data("id"),d=a.length&&a.find(".item-edit-input"),r=d&&d.val(),l="column.item.save error";d.length?r?($.radio("log").broadcast({key:"column.item.save",value:d}),n||(t="editId not exist"),d||(t="input not exist"),t||$.radio("column.data.item.add").broadcast({parent:i,key:n,value:r}),d&&d.length&&d.remove(),a.find(".content").html(r).show(),o.find(".action-wrap").show(),a.removeClass("item-edit"),a.data("id",n),a.addClass("draggable"),$.radio("column.events.drag.bind").broadcast({wrap:a}),o.find(".item-edit").length||(console.log(o.find(".item-edit")),$.radio("column.item.add").broadcast({wrap:o,content:""}))):t="input value empty":t="input el not exists",t&&$.radio("log").broadcast({key:l,value:t})})},this),function(e,t,o){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof o.define&&o.define.amd?define(e,t):o[e]=t()}("column.resize",function(){var e,t="column.resize";$.radio(t).subscribe(function(){e=$.viewport().height-$(".column-view-header").height()-$(".column-view-footer").height(),$(".column-view-wrap").css({height:e}),$.radio("log").broadcast({key:t,value:" set list-wrap height to viewport height "+e})})},this);